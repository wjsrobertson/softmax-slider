<html>
<head>
    <script src="libs/Chart.bundle.js"></script>
    <script src="libs/jquery-3.2.1.min.js"></script>
    <script src="libs/bootstrap/js/bootstrap.js"></script>
    <script src="libs/slider/js/bootstrap-slider.js"></script>
    <script src="libs/lodash.min.js"></script>
    <script src="libs/html5shiv.min.js"></script>
    <link rel="stylesheet" href="libs/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="libs/bootstrap/css/bootstrap-theme.css">
    <link rel="stylesheet" href="libs/slider/css/slider.css">

    <style>
        .template {
            display: none;
        }

        .category-name {
            padding: 3px;
        }

        #category-controls > div {
            padding: 3px;
            border:1px solid;
            border-radius: 6px;
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1>Panels</h1>
</div>
<div class="row">
    <div class="col-sm-3">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2 class="panel-title">Category Weights</h2>
            </div>
            <div class="panel-body">

                <div class="form-group">
                    <button id="add-category" type="button" class="btn btn-default btn-md">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>
                    <label for="add-category">
                        <small>Add new category</small>
                    </label>
                </div>

                <hr/>

                <div id="category-control-template" class="template">
                    <div class="form-group" use="category-slider">
                        <div class="category-slider">
                            <div use="category-name" class="category-name"></div>

                            <button title="remove" use="remove" type="button" class="btn btn-default btn-sm span1">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>

                            <input use="slider" type="text" value="" data-slider-min="0" data-slider-max="10" data-slider-step="0.1"
                                   data-slider-value="0" data-slider-selection="after" data-slider-tooltip="hide">
                        </div>
                    </div>
                </div>

                <div id="category-controls" class="form-group">
                </div>

                <div class="alert alert-info">
                    Each category weight can vary on a scale from 0 to 10 in this example
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Category Probability Scores (Softmax Output)</h3>
            </div>
            <div class="panel-body">
                <canvas id="softmax-chart-container" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-sm-4">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Category Weights (Softmax Input)</h3>
            </div>
            <div class="panel-body">
                <canvas id="input-chart-container" width="300" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<script>

    var smax = {};

    smax.softmax = function (input) {
        _.map(input, function (value) {
            return value / 2;
        })
    };

    smax.data = {
        maxValue: 10,
        raw: [],
        softmax: []
    };

    smax.CategorySource = (function () {
        var nameIndex = -1;

        var colourIndex = -1;

        var names = [
            'Aardvark','Albatross','Alligator','Alpaca','Ant','Anteater','Antelope','Ape','Armadillo','Ass','Baboon','Badger','Barracuda','Bat','Bear','Beaver',
            'Bee','Bison','Boar','Buffalo','Galago','Butterfly','Camel','Caribou','Cat','Caterpillar','Cattle','Chamois','Cheetah','Chicken','Chimpanzee',
            'Chinchilla','Chough','Clam','Cobra','Cockroach','Cod','Cormorant','Coyote','Crab','Crane','Crocodile','Crow','Curlew','Deer','Dinosaur','Dog',
            'Dogfish','Dolphin','Donkey','Dotterel','Dove','Dragonfly','Duck','Dugong','Dunlin','Eagle','Echidna','Eel','Eland','Elephant','Elephant seal',
            'Elk','Emu','Falcon','Ferret','Finch','Fish','Flamingo','Fly','Fox','Frog','Gaur','Gazelle','Gerbil','Giant Panda','Giraffe','Gnat','Gnu','Goat',
            'Goose','Goldfinch','Goldfish','Gorilla','Goshawk','Grasshopper','Grouse','Guanaco','Guinea fowl','Guinea pig','Gull','Hamster','Hare','Hawk',
            'Hedgehog','Heron','Herring','Hippopotamus','Hornet','Horse','Human','Hummingbird','Hyena','Jackal','Jaguar','Jellyfish','Kangaroo','Koala',
            'Komodo dragon','Kouprey','Kudu','Lapwing','Lark','Lemur','Leopard','Lion','Llama','Lobster','Locust','Loris','Louse','Lyrebird','Magpie','Mallard',
            'Manatee','Marten','Meerkat','Mink','Mole','Monkey','Moose','Mouse','Mosquito','Mule','Narwhal','Newt','Nightingale','Octopus','Okapi','Opossum',
            'Oryx','Ostrich','Otter','Owl','Ox','Oyster','Panther','Parrot','Partridge','Peafowl','Pelican','Penguin','Pheasant','Pig','Pigeon','Pony',
            'Porcupine','Porpoise','Prairie Dog','Quail','Quelea','Rabbit','Raccoon','Rail','Ram','Rat','Raven','Red deer','Red panda','Reindeer','Rhinoceros',
            'Rook','Ruff','Salamander','Salmon','Sand Dollar','Sandpiper','Sardine','Scorpion','Sea lion','Sea Urchin','Seahorse','Seal','Shark','Sheep',
            'Shrew','Shrimp','Skunk','Snail','Snake','Spider','Squid','Squirrel','Starling','Stingray','Stinkbug','Stork','Swallow','Swan','Tapir','Tarsier',
            'Termite','Tiger','Toad','Trout','Turkey','Turtle','Vicu√±a','Viper','Vulture','Wallaby','Walrus','Wasp','Water buffalo','Weasel','Whale','Wolf',
            'Wolverine','Wombat','Woodcock','Woodpecker','Worm','Wren','Yak','Zebra'];

        var backgroundColours = ['rgba(255, 99, 132, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 206, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(255, 159, 64, 0.2)'
        ];

        var borderColours = [
            'rgba(255,99,132,1)',
            'rgba(54, 162, 235, 1)',
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(153, 102, 255, 1)',
            'rgba(255, 159, 64, 1)'
        ];

        function nextName() {
            nameIndex = Math.floor(Math.random() * names.length);
            return names[nameIndex]
        }

        function nextColour() {
            colourIndex = (colourIndex + 1) % backgroundColours.length;
            return {background: backgroundColours[colourIndex], border: borderColours[colourIndex]};
        }

        return {
            newCategory: function () {
                var colour = nextColour();
                var name = nextName();

                return {
                    background: colour.background,
                    border: colour.border,
                    name: name
                }
            }
        }
    })();

    smax.Chart = (function (softmaxChartContainerId, inputChartContainerId) {
        Chart.defaults.global.legend.display = false;

        var chartContainer = $('#' + softmaxChartContainerId);
        var inputChartContainer = $('#' + inputChartContainerId);

        var inputChart = new Chart(inputChartContainer, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        position: 'left',
                        ticks: {
                            beginAtZero: true
                        }, scaleLabel: {
                            display: true,
                            labelString: 'Input value'
                        }
                    }]
                }
            }
        });

        var softmaxChart = new Chart(chartContainer, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        position: 'left',
                        ticks: {
                            beginAtZero: true
                        }, scaleLabel: {
                            display: true,
                            labelString: 'SoftMax output value'
                        }
                    }]
                }
            }
        });

        function updateCategoryValue(index, inputValue, softmaxValue) {
            inputChart.config.data.datasets[0].data[index] = inputValue;
            softmaxChart.config.data.datasets[0].data[index] = softmaxValue;
        }

        return {
            newCategory: function (category) {
                var index = smax.data.raw.length;
                var inputValue = Math.random() * smax.data.maxValue;
                getCategorySlider(index).slider('setValue', inputValue);
                smax.data.raw.push(inputValue);
                reclaculate();

                getCategorySliderContainer(index).style.backgroundColor = category.background;
                getCategorySliderContainer(index).style.borderColor = category.border;
                getCategorySliderName(index).text(category.name);

                inputChart.config.data.labels.push(category.name);
                inputChart.config.data.datasets[0].data.push(inputValue);
                inputChart.config.data.datasets[0].backgroundColor.push(category.background);
                inputChart.config.data.datasets[0].borderColor.push(category.border);

                var softmaxValue = smax.data.softmax[index];
                softmaxChart.config.data.labels.push(category.name);
                softmaxChart.config.data.datasets[0].data.push(softmaxValue);
                softmaxChart.config.data.datasets[0].backgroundColor.push(category.background);
                softmaxChart.config.data.datasets[0].borderColor.push(category.border);
            },
            removeCategory: function (index) {
                removeCategorySlider(index);

                smax.data.raw.splice(index, 1);
                smax.data.softmax.splice(index, 1);
                inputChart.config.data.labels.splice(index, 1);
                inputChart.config.data.datasets[0].data.splice(index, 1);
                inputChart.config.data.datasets[0].backgroundColor.splice(index, 1);
                inputChart.config.data.datasets[0].borderColor.splice(index, 1);

                softmaxChart.config.data.labels.splice(index, 1);
                softmaxChart.config.data.datasets[0].data.splice(index, 1);
                softmaxChart.config.data.datasets[0].backgroundColor.splice(index, 1);
                softmaxChart.config.data.datasets[0].borderColor.splice(index, 1);
            },
            updateCategoryValues: function () {
                _.forEach(smax.data.raw, function (inputValue, index) {
                    var softmaxValue = smax.data.softmax[index];
                    updateCategoryValue(index, inputValue, softmaxValue);

                });
            },
            render: function () {
                inputChart.update();
                softmaxChart.update();
            }
        };
    })("softmax-chart-container", "input-chart-container");

    function getSliderValues() {
        var sliderControl = $('#category-controls').children();

        var sliders = _.map(sliderControl, function (container) {
            return $(container).find("input[use='slider']");
        });

        var values = _.map(sliders, function (slider) {
            return slider.slider('getValue')[0].value;
        });

        return values;
    }

    function reclaculate() {
        var exps = _.map(smax.data.raw, function (value) {
            return Math.exp(value);
        });

        var sum = _.sum(exps);

        smax.data.softmax = _.map(exps, function (exp) {
            return exp / sum;
        });

        console.log(_.join(smax.data.softmax, ', '));

    }

    function getCategorySlider(index) {
        return $($('#category-controls').children()[index]).find("input[use='slider']");
    }

    function getCategorySliderName(index) {
        return $($('#category-controls').children()[index]).find("div[use='category-name']");
    }

    function getCategorySliderContainer(index) {
        return $('#category-controls').children()[index];
    }


    function removeCategorySlider(index) {
        $('#category-controls').children()[index].remove();
    }

    smax.PageBinder = (function (categoryControlTemplateId, categoryControlsId, addCategoryButtonId) {
        var template = $('#' + categoryControlTemplateId).children().first();

        $('#' + addCategoryButtonId).click(function () {
            addNewCategory();
        });

        function addNewCategory() {
            var control = template.clone().appendTo('#' + categoryControlsId);

            control.find("input[use='slider']").slider().on('slide', function (ev) {
                var index = $(ev.target).parent().parent().parent().index();
                smax.data.raw[index] = ev.value;
                reclaculate();
                smax.Chart.updateCategoryValues();
                smax.Chart.render();
            });
            control.find("button[use='remove']").click(function (ev) {
                var index = $(ev.target).parent().parent().parent().index();
                smax.Chart.removeCategory(index);
                smax.Chart.render();
            });

            var newCategory = smax.CategorySource.newCategory();
            smax.Chart.newCategory(newCategory);
            smax.Chart.render();
        }
    })('category-control-template', 'category-controls', 'add-category');


</script>

</body>
</html>